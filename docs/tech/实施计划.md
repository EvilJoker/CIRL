# 应用问答优化平台实施计划

## 一、方案概述

基于用户需求，将 CIRL 系统重构为**以应用为中心的知识库优化平台**，核心功能包括：

1. **问答记录跟踪**：记录 input/output，关联应用
2. **时间范围筛选**：支持按应用和时间范围筛选问答记录
3. **反馈闭环**：收集反馈，AI 分析，生成优化建议
4. **数据集管理**：围绕应用创建数据集（作为标准答案集）
5. **命中分析**：监控问答记录与数据集的匹配情况（完全命中、80%相似、60%相似、未命中）
6. **效果评估**：评估应用在数据集上的表现（准确性优先，速度次之）
7. **优化前后对比**：对比优化前后的评估结果

## 二、核心概念

### 2.1 应用为中心

- **应用是核心角色**：所有问答记录、数据集、评估都围绕应用
- **不需要知识项**：问答记录直接关联应用，不涉及知识项概念

### 2.2 数据集的作用

- **数据集作为标准答案集**：包含问答记录，用于匹配和评估
- **命中分析**：通过相似度匹配，监控问答记录与数据集的匹配情况
- **效果评估**：使用数据集评估应用的表现

### 2.3 数据流程

```
应用 (App)
    ↓
问答记录 (QueryRecord) ← 用户反馈 (Feedback)
    ↓
数据集 (Dataset) ← 命中分析 (HitAnalysis)
    ↓
效果评估 (Evaluation)
    ↓
优化建议 (OptimizationSuggestion)
```

## 三、技术实施

### 3.1 主题配置

- **主题色**：Blue（已更新 `components.json`）
- **风格**：new-york
- **组件库**：shadcn-vue

### 3.2 数据文件结构

```
data/
├── apps.json                  # 应用
├── query-records.json         # 问答记录
├── feedbacks.json             # 反馈
├── datasets.json              # 数据集
├── hit-analyses.json          # 命中分析
├── evaluations.json           # 效果评估
└── optimization-suggestions.json # 优化建议
```

### 3.3 API 端点规划

| 模块 | 端点 | 方法 | 说明 |
|------|------|------|------|
| 应用管理 | `/api/apps` | GET, POST, PUT, DELETE | 应用管理 |
| 问答记录 | `/api/query-records` | GET, POST, PUT | 查询、创建问答记录（支持时间范围筛选） |
| 反馈 | `/api/feedbacks` | GET, POST, PUT | 反馈管理 |
| 数据集 | `/api/datasets` | GET, POST, PUT, DELETE | 数据集管理 |
| 命中分析 | `/api/hit-analyses` | GET, POST | 命中分析任务与结果 |
| 效果评估 | `/api/evaluations` | GET, POST | 评估任务与结果 |
| 优化建议 | `/api/optimization-suggestions` | GET, PUT | 优化建议管理 |
| AI 服务 | `/api/ai/similarity` | POST | 相似度计算（预留） |
| AI 服务 | `/api/ai/analyze` | POST | 优化建议生成（预留） |

### 3.4 前端页面结构

```
src/
├── pages/
│   ├── AppManagementPage.vue          # 应用管理
│   ├── QueryTrackingPage.vue          # 问答跟踪
│   ├── FeedbackManagementPage.vue     # 反馈管理
│   ├── DatasetManagementPage.vue      # 数据集管理
│   ├── HitAnalysisPage.vue             # 命中分析
│   └── EvaluationPage.vue              # 效果评估
├── components/
│   ├── app/
│   │   ├── AppList.vue
│   │   ├── AppForm.vue
│   │   └── AppDetail.vue
│   ├── query/
│   │   ├── QueryRecordList.vue
│   │   ├── QueryRecordCard.vue
│   │   ├── QueryRecordDetail.vue
│   │   ├── DateRangePicker.vue
│   │   └── AppSelector.vue
│   ├── feedback/
│   │   ├── FeedbackList.vue
│   │   ├── FeedbackCard.vue
│   │   ├── FeedbackForm.vue
│   │   └── OptimizationSuggestion.vue
│   ├── dataset/
│   │   ├── DatasetList.vue
│   │   ├── DatasetForm.vue
│   │   ├── DatasetDetail.vue
│   │   └── QueryRecordSelector.vue
│   ├── hit-analysis/
│   │   ├── HitAnalysisForm.vue
│   │   ├── HitAnalysisResult.vue
│   │   ├── HitDistributionChart.vue
│   │   └── HitAnalysisDetail.vue
│   └── evaluation/
│       ├── EvaluationForm.vue
│       ├── EvaluationResult.vue
│       ├── EvaluationComparison.vue
│       └── EvaluationReport.vue
```

## 四、实施步骤

### Step 1: 更新数据模型定义

**文件**：`web/src/types/index.ts`

定义新的 TypeScript 接口：
- `App`
- `QueryRecord`
- `Feedback`
- `Dataset`
- `HitAnalysis`
- `Evaluation`
- `OptimizationSuggestion`

### Step 2: 创建数据文件

在 `data/` 目录下创建：
- `apps.json` - 初始为空数组 `[]`
- `query-records.json` - 初始为空数组 `[]`
- `feedbacks.json` - 初始为空数组 `[]`
- `datasets.json` - 初始为空数组 `[]`
- `hit-analyses.json` - 初始为空数组 `[]`
- `evaluations.json` - 初始为空数组 `[]`
- `optimization-suggestions.json` - 初始为空数组 `[]`

### Step 3: 实现后端 API

**文件**：`server/index.js`

实现以下路由：
1. 应用 CRUD
2. 问答记录 CRUD（支持时间范围筛选）
3. 反馈 CRUD
4. 数据集 CRUD
5. 命中分析创建与查询
6. 效果评估创建与查询
7. 优化建议查询与更新

**文件**：`server/dataManager.js`

添加数据读写函数：
- `readApps()`, `saveApps()`
- `readQueryRecords()`, `saveQueryRecords()`
- `readFeedbacks()`, `saveFeedbacks()`
- `readDatasets()`, `saveDatasets()`
- `readHitAnalyses()`, `saveHitAnalyses()`
- `readEvaluations()`, `saveEvaluations()`
- `readOptimizationSuggestions()`, `saveOptimizationSuggestions()`

**文件**：`server/similarityService.js`（新建）

实现相似度计算：
- 初期使用简单算法（余弦相似度、编辑距离）
- 预留 AI 接口

**文件**：`server/evaluationService.js`（新建）

实现评估指标计算：
- 准确性指标（完全命中率、高相似度命中率等）
- 速度指标（平均响应时间、P95）
- 综合评分

### Step 4: 实现命中分析逻辑

**文件**：`server/hitAnalysisService.js`（新建）

实现命中分析：
1. 根据应用、数据集、时间范围筛选问答记录
2. 对每条问答记录，与数据集中的问答记录进行相似度匹配
3. 分类为：完全命中、80%相似、60%相似、未命中
4. 生成命中分析结果
5. AI 分析命中情况，生成优化建议（预留）

### Step 5: 更新前端 API 客户端

**文件**：`web/src/lib/api.ts`

添加新的 API 调用函数：
- `fetchApps()`, `createApp()`, `updateApp()`, `deleteApp()`
- `fetchQueryRecords()`, `createQueryRecord()`（支持时间范围参数）
- `fetchFeedbacks()`, `createFeedback()`, `updateFeedback()`, `analyzeFeedback()`
- `fetchDatasets()`, `createDataset()`, `updateDataset()`, `deleteDataset()`
- `createHitAnalysis()`, `fetchHitAnalyses()`, `fetchHitAnalysisStats()`, `analyzeHitAnalysis()`
- `createEvaluation()`, `fetchEvaluations()`, `compareEvaluations()`, `fetchEvaluationReport()`
- `fetchOptimizationSuggestions()`, `updateOptimizationSuggestion()`

### Step 6: 重构导航结构

**文件**：`web/src/components/layout/SidebarPanel.vue`

更新导航项：
- 应用管理
- 问答跟踪
- 反馈管理
- 数据集管理
- 命中分析
- 效果评估

### Step 7: 实现前端页面

按顺序实现：
1. 应用管理页面
2. 问答跟踪页面（支持时间范围筛选）
3. 反馈管理页面
4. 数据集管理页面
5. 命中分析页面
6. 效果评估页面

### Step 8: 更新路由

**文件**：`web/src/router/index.ts`

更新路由配置，移除旧路由，添加新路由。

### Step 9: 实现时间范围选择器

**文件**：`web/src/components/query/DateRangePicker.vue`（新建）

使用 shadcn-vue 的 DatePicker 组件，实现时间范围选择。

### Step 10: 实现图表组件

**文件**：`web/src/components/hit-analysis/HitDistributionChart.vue`（新建）
**文件**：`web/src/components/evaluation/EvaluationComparison.vue`（新建）

使用简单的图表库（如 recharts 或 chart.js）实现图表展示。

## 五、关键实现细节

### 5.1 问答记录创建

当外部应用调用接口时：
1. 记录 input（用户问题）
2. 记录 output（应用回答）
3. 关联 appId
4. 保存到 `query-records.json`

### 5.2 时间范围筛选

在查询问答记录时：
```typescript
GET /api/query-records?appId=xxx&startDate=2024-01-01&endDate=2024-12-31
```

后端过滤 `createdAt` 字段在时间范围内的记录。

### 5.3 反馈处理流程

1. 用户在问答记录详情页提交反馈
2. 反馈状态初始为 `pending`
3. 调用 AI 分析接口（预留），生成优化建议
4. 反馈状态更新为 `processed`
5. 优化建议关联到应用

### 5.4 数据集构建

1. 用户在数据集管理页面点击"创建数据集"
2. 打开问答记录选择器（多选，支持时间范围筛选）
3. 选择要包含的问答记录
4. 填写数据集名称和描述
5. 关联到应用
6. 保存数据集

### 5.5 命中分析

1. 选择应用、数据集、时间范围
2. 系统筛选该时间范围内的问答记录
3. 对每条问答记录，与数据集中的问答记录进行相似度匹配：
   - 计算相似度（0-100）
   - 分类：完全命中（>=100%）、高相似度（>=80%）、中等相似度（>=60%）、未命中（<60%）
4. 生成命中分析结果
5. 统计命中分布
6. AI 分析命中情况，生成优化建议（预留）

### 5.6 效果评估

1. 选择应用、数据集、时间范围、评估类型（优化前/优化后）
2. 系统筛选该时间范围内的问答记录
3. 计算评估指标：
   - 准确性：完全命中率、高相似度命中率、平均评分等
   - 速度：平均响应时间、P95 响应时间
4. 生成评估结果
5. 支持对比优化前后的评估结果

### 5.7 相似度计算（初期实现）

使用简单的文本相似度算法：

```javascript
// 余弦相似度
function cosineSimilarity(text1, text2) {
  // 实现余弦相似度计算
}

// 编辑距离相似度
function editDistanceSimilarity(text1, text2) {
  // 实现编辑距离相似度计算
}

// 综合相似度
function calculateSimilarity(text1, text2) {
  const cosine = cosineSimilarity(text1, text2)
  const edit = editDistanceSimilarity(text1, text2)
  return (cosine * 0.6) + (edit * 0.4) // 加权平均
}
```

后续接入 AI 服务时，替换为 AI 接口调用。

## 六、测试要点

### 6.1 功能测试

- [ ] 应用创建和管理
- [ ] 问答记录创建和查询（时间范围筛选）
- [ ] 反馈提交和处理
- [ ] 数据集创建和管理
- [ ] 命中分析计算和展示
- [ ] 效果评估计算和对比

### 6.2 数据一致性测试

- [ ] 问答记录与应用关联
- [ ] 反馈与问答记录关联
- [ ] 数据集与问答记录关联
- [ ] 命中分析与数据集关联
- [ ] 评估结果准确性

### 6.3 性能测试

- [ ] 大量问答记录的查询性能
- [ ] 命中分析的性能（相似度计算）
- [ ] 效果评估计算的性能

### 6.4 相似度准确性测试

- [ ] 完全匹配的识别准确性
- [ ] 80%相似度的识别准确性
- [ ] 60%相似度的识别准确性

## 七、后续优化方向

1. **AI 服务接入**：接入专业的相似度计算和优化建议生成服务
2. **批量操作**：支持批量命中分析、批量评估
3. **可视化增强**：更丰富的图表展示命中分布和评估结果
4. **自动优化建议**：基于命中分析和评估结果自动生成优化建议
5. **评估任务调度**：支持定时评估任务
6. **数据导出**：支持导出评估报告为 PDF/Excel

---

> **参考文档**：
> - `docs/design.md` - 设计总纲
> - `docs/rfcs/RFC-002-知识库优化平台重构方案.md` - 详细方案
