# CIRL 快速开发指南

本指南面向开发者，帮助快速搭建开发环境、进行开发调试以及部署应用。

## 环境要求

### 开发环境

- Node.js >= 20.0.0
- npm
- Git

### 容器化部署

- Docker >= 20.10
- Docker Compose >= 2.0（或 docker-compose >= 1.29）

## 快速启动

### 方式一：容器化部署（推荐）

```bash
# 启动容器（自动构建镜像并启动）
./start.sh

# 停止容器
./stop.sh

# 查看日志
cd docker && docker-compose logs -f
```

**访问地址**：http://localhost:10001

### 方式二：本地开发模式

```bash
# 本地启动（适合开发调试）
./start.sh --local
```

脚本会自动：
- 检查并安装依赖
- 启动后端服务器（端口 10001）
- 启动前端开发服务器（端口 10002）

按 `Ctrl+C` 停止服务

**访问地址**：
- 前端：http://localhost:10002
- 后端：http://localhost:10001

### 方式三：手动启动

#### 1. 安装依赖

```bash
# 根目录安装依赖
npm install

# 前端安装依赖
cd web && npm install && cd ..
```

#### 2. 启动服务

**终端 1 - 启动后端服务器**:
```bash
npm run dev:server
```

后端运行在 `http://localhost:10001`

**终端 2 - 启动前端开发服务器**:
```bash
npm run dev
```

前端运行在 `http://localhost:10002`

## 项目结构详解

```
cirl/
├── bin/                      # CLI 工具
├── server/                   # Express 后端
│   ├── index.js              # 服务器入口（包含所有 API 路由）
│   ├── dataManager.js        # JSON 数据读写管理
│   ├── similarityService.js  # 相似度计算服务
│   ├── evaluationService.js  # 评估指标计算服务
│   └── swagger.js            # Swagger/OpenAPI 配置
├── web/                      # Vue 3 前端
│   └── src/
│       ├── components/       # Vue 组件
│       │   ├── layout/      # 布局组件（Sidebar 等）
│       │   ├── ui/          # UI 组件库（shadcn-vue）
│       │   └── ...
│       ├── pages/            # 页面组件
│       │   ├── AppManagementPage.vue
│       │   ├── QATrackingPage.vue
│       │   ├── QAManagementPage.vue
│       │   ├── FeedbackManagementPage.vue
│       │   ├── QADatasetPage.vue
│       │   ├── TagManagementPage.vue
│       │   ├── HitAnalysisPage.vue
│       │   └── EvaluationPage.vue
│       ├── lib/              # 工具库
│       │   ├── api.ts       # API 调用封装
│       │   └── utils.ts     # 工具函数
│       ├── types/            # TypeScript 类型定义
│       └── router/           # 路由配置
├── data/                     # 数据文件（JSON）
│   ├── apps.json
│   ├── query-records.json
│   ├── feedbacks.json
│   ├── datasets.json
│   ├── hit-analyses.json
│   ├── evaluations.json
│   └── optimization-suggestions.json
├── docker/                   # Docker 相关文件
│   ├── Dockerfile
│   ├── docker-compose.yml
│   └── .dockerignore
└── docs/                     # 文档
```

## 开发调试

### 前端调试

1. **Vue DevTools**
   - 安装浏览器扩展：Vue.js devtools
   - 查看组件状态、Props、Events

2. **浏览器控制台**
   - 查看 API 请求/响应
   - 查看 Vue 组件日志
   - 网络请求调试

3. **热重载**
   - 修改代码后自动刷新
   - 保持组件状态（HMR）

### 后端调试

1. **查看服务器日志**
   ```bash
   # 实时查看日志
   tail -f server.log
   ```

2. **检查数据文件**
   ```bash
   # 查看数据文件
   cat data/apps.json
   cat data/query-records.json
   ```

3. **API 测试**
   - 使用 Swagger UI：http://localhost:10001/api-docs
   - 使用 curl 或 Postman

### 常见调试场景

#### 修改 API 接口

1. 编辑 `server/index.js` 中的路由处理函数
2. 后端会自动重启（如果使用 nodemon）或手动重启
3. 在 Swagger UI 中测试新接口

#### 修改前端页面

1. 编辑 `web/src/pages/` 中的页面组件
2. 浏览器自动刷新，查看效果
3. 使用 Vue DevTools 检查组件状态

#### 修改数据模型

1. 更新 `web/src/types/index.ts` 中的类型定义
2. 同步更新 `server/index.js` 中的数据处理逻辑
3. 更新 `docs/PROJECT_OVERVIEW.md` 中的数据模型文档

## 数据文件格式

所有数据文件位于 `data/` 目录，使用 JSON 格式存储。

### 主要数据文件

- `apps.json` - 应用列表
- `query-records.json` - 问答记录
- `feedbacks.json` - 反馈记录
- `datasets.json` - 数据集
- `hit-analyses.json` - 命中分析结果
- `evaluations.json` - 评估结果
- `optimization-suggestions.json` - 优化建议

完整的数据模型定义请参考：
- `docs/PROJECT_OVERVIEW.md` - 数据模型章节
- `web/src/types/index.ts` - TypeScript 类型定义

## 构建

### 构建前端

```bash
npm run build
```

构建产物在 `dist/` 目录。

### 构建验证

```bash
# 构建后预览
npm run build
cd web && npm run preview
```

## 容器化部署

### 手动操作

```bash
# 进入 docker 目录
cd docker

# 构建镜像
docker-compose build

# 启动容器
docker-compose up -d

# 停止容器
docker-compose down

# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs -f cirl
```

### 配置说明

#### 数据持久化

数据文件存储在项目根目录的 `./data/` 目录，通过 Docker volume 挂载到容器内，确保数据持久化。

#### 端口配置

- **后端端口**：10001
- **修改端口**：编辑 `docker/docker-compose.yml` 中的端口映射：
  ```yaml
  ports:
    - "10001:10001"  # 宿主机端口:容器端口
  ```

#### 环境变量

可在 `docker/docker-compose.yml` 中配置环境变量：

```yaml
environment:
  - NODE_ENV=production
  - PORT=10001
```

或使用 `.env` 文件：

```bash
# 创建 .env 文件
cat > docker/.env << EOF
NODE_ENV=production
PORT=10001
EOF
```

然后在 `docker-compose.yml` 中引用：
```yaml
env_file:
  - .env
```

#### npm 镜像/代理配置

如果构建时需要配置 npm 镜像源或代理，可以通过环境变量传递：

```bash
# 设置 npm 镜像源（可选，默认使用 https://registry.npmmirror.com）
export NPM_REGISTRY=https://registry.npmmirror.com

# 设置代理（如果需要）
export NPM_PROXY=http://your-proxy:port
export NPM_HTTPS_PROXY=http://your-proxy:port

# 启动构建
./start.sh
```

或在 `docker/.env` 文件中配置：

```bash
cat > docker/.env <<'EOF'
NPM_REGISTRY=https://registry.npmmirror.com
NPM_PROXY=http://your-proxy:port
NPM_HTTPS_PROXY=http://your-proxy:port
EOF
```

**注意**：如果不设置代理，容器将直接访问外网。如果网络环境需要代理，请根据实际情况配置。

### 健康检查

容器包含健康检查，可通过以下命令查看：

```bash
# 查看容器健康状态
docker ps
# 查看 HEALTH STATUS 列

# 查看详细信息
docker inspect cirl | grep -A 10 Health
```

## 生产环境部署

### 1. 构建生产镜像

```bash
cd docker
docker-compose build --no-cache
```

### 2. 配置环境变量

创建 `docker/.env.production`：
```bash
NODE_ENV=production
PORT=10001
```

### 3. 数据备份策略

```bash
# 定期备份数据目录
tar -czf backup-$(date +%Y%m%d).tar.gz data/
```

### 4. 资源限制

在 `docker/docker-compose.yml` 中添加资源限制：

```yaml
deploy:
  resources:
    limits:
      cpus: '1'
      memory: 1G
    reservations:
      cpus: '0.5'
      memory: 512M
```

### 5. 日志管理

```bash
# 配置日志轮转
docker-compose logs --tail=1000 -f > logs/app.log
```

### 6. 监控告警

- 使用容器健康检查（已配置）
- 集成监控系统（Prometheus、Grafana 等）
- 配置告警规则

## 升级部署

### 更新代码

```bash
# 拉取最新代码
git pull

# 重新构建并启动
cd docker
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### 数据迁移

数据文件在 `./data/` 目录，升级时无需特殊处理，只需确保：
1. 备份现有数据
2. 停止旧容器
3. 启动新容器（使用相同的数据目录挂载）

## 代码规范

### TypeScript

- 使用 TypeScript 严格模式
- 所有类型定义在 `web/src/types/index.ts`
- API 调用使用类型安全的封装（`lib/api.ts`）

### 代码风格

- 使用 ESLint 和 Prettier（如果配置）
- 遵循 Vue 3 Composition API 最佳实践
- 组件使用 `<script setup>` 语法

## 故障排查

### 端口被占用

```bash
# 检查端口占用
lsof -i:10001  # 后端
lsof -i:10002  # 前端

# 修改端口
# 后端：修改 server/index.js 中的 PORT
# 前端：修改 web/vite.config.ts 中的 server.port
```

### 容器无法启动

1. **检查端口占用**
   ```bash
   lsof -i:10001
   ```

2. **查看容器日志**
   ```bash
   cd docker && docker-compose logs cirl
   ```

3. **检查镜像构建**
   ```bash
   cd docker && docker-compose build --no-cache
   ```

4. **检查 Docker 服务**
   ```bash
   docker ps
   docker info
   ```

### 依赖安装失败

```bash
# 清理缓存重新安装
rm -rf node_modules package-lock.json
rm -rf web/node_modules web/package-lock.json
npm install
cd web && npm install && cd ..
```

### 数据文件损坏

```bash
# 备份后重新初始化
cp -r data data.backup
# 删除损坏的文件，系统会自动创建空数组 []
```

### 数据丢失

确保 `./data/` 目录存在且有写权限：
```bash
mkdir -p data
chmod 755 data
```

### 服务无法访问

1. **检查容器是否运行**
   ```bash
   docker ps | grep cirl
   ```

2. **检查端口映射**
   ```bash
   docker port cirl
   ```

3. **检查防火墙设置**
   ```bash
   # CentOS/RHEL
   firewall-cmd --list-ports
   firewall-cmd --add-port=10001/tcp --permanent
   firewall-cmd --reload
   ```

4. **测试容器内部连接**
   ```bash
   docker exec -it cirl wget -O- http://localhost:10001/api/apps
   ```

### API 请求失败

1. 检查后端是否启动：`curl http://localhost:10001/api/apps`
2. 检查 CORS 配置（`server/index.js`）
3. 查看浏览器控制台的错误信息

### 性能问题

1. **查看容器资源使用**
   ```bash
   docker stats cirl
   ```

2. **检查日志大小**
   ```bash
   docker-compose logs --tail=1000
   ```

3. **优化构建**
   - 使用多阶段构建（已实现）
   - 清理不必要的依赖

## 安全建议

1. **使用环境变量**：敏感信息通过环境变量配置
2. **数据加密**：生产环境考虑数据加密存储
3. **访问控制**：配置防火墙和访问限制
4. **定期更新**：保持 Docker 和基础镜像更新
5. **日志审计**：配置日志审计和监控

## API 文档

启动服务后，访问 **http://localhost:10001/api-docs** 查看交互式 API 文档（Swagger UI），支持在线测试所有接口。

## 下一步

- 查看 [API 参考文档](docs/tech/api-reference.md) 了解接口详情
- 查看 [项目总览](docs/PROJECT_OVERVIEW.md) 了解整体架构
- 查看 [设计总纲](docs/design.md) 了解设计思路

